<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Calculateur score Mini-NIHSS</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#5b8cff">
  <style>
    :root {
      --bg: #e9edf5;
      --card: #eef2f9;
      --text: #0f1218;
      --muted: #5f6b7a;
      --accent: #5b8cff;
      --ok: #19b37a;
      --warn: #ffb020;
      --bad: #ff5c7a;
      --shadow-dark: #b6c0d0;
      --shadow-light: #ffffff;
      --radius: 18px;
      --pad: 16px;
    }
    body { margin:0; font-family: sans-serif; background:var(--bg); color:var(--text); }
    .app { max-width: 600px; margin:0 auto; padding:16px; }
    .topbar { position:sticky; top:0; padding:12px; background:var(--card); box-shadow:0 2px 6px rgba(0,0,0,.2); display:flex; justify-content:center; }
    .card { background:var(--card); padding:var(--pad); border-radius:var(--radius); box-shadow:2px 2px 6px var(--shadow-dark), -2px -2px 6px var(--shadow-light); }
    .card h3 { margin-top:0; }
    .sub { color:var(--muted); font-size:14px; margin-bottom:10px; }
    .control { display:flex; flex-direction:column; gap:10px; }

    /* --- Réponses (séparées + état sélectionné visible) --- */
    .seg {
      padding:14px;
      background:var(--bg);
      border:0;
      border-bottom:1px solid #ddd;
      text-align:left;
      font-size:16px;
      cursor:pointer;
    }
    .seg:last-child { border-bottom:0; }
    .seg[aria-pressed="true"] {
      background: var(--accent);
      color: white;
      font-weight:bold;
    }

    /* --- Boutons navigation --- */
    .card .control:last-child {
      margin-top:20px;
    }

    .btn { background:#cccc; padding:12px 16px; border-radius:12px; border:0; cursor:pointer; }
    .btn.primary { background:var(--accent); color:white; }

    .resultFinal {
      text-align:center;
      margin-top:30px;
      font-size:24px;
      font-weight:bold;
    }
    .fabbar { position:fixed; bottom:0; left:0; right:0; background:var(--bg); padding:10px; display:flex; justify-content:center; gap:12px; }
    .chip { padding:8px 12px; border-radius:999px; background:var(--card); }
    .pill { font-weight:bold; }
    .ok{color:var(--ok);} .warn{color:var(--warn);} .bad{color:var(--bad);}

    /* Image / plein écran / actions */
    .img-wrap { text-align:center; margin:12px 0; }
    .obj-img { max-width:100%; height:auto; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.12); cursor:zoom-in; }
    .img-actions { display:flex; justify-content:center; gap:10px; margin-top:10px; }
    .hidden-options { display:none; }

    /* petit style pour message d'erreur image */
    .img-error { color:#b00; font-weight:600; padding:8px; }
  </style>
</head>
<body>
  <div class="topbar"><h1>Calcul Mini-NIHSS SB ®</h1></div>
  <main class="app">
    <section id="questions"></section>

    <section id="summary">
      <strong>Résumé</strong>
      <div class="sub" id="chosenCount">0/9 éléments renseignés</div>
    </section>
    <div id="finalResult" class="resultFinal" style="display:none;"></div>
  </main>
  <div class="fabbar">
    <div class="chip">Score <span id="scoreVal" class="pill">0</span></div>
    <div class="chip">Gravité <span id="band" class="pill ok">minime</span></div>
  </div>

<script>
  const NIHSS = [
      { id: '1', label: '1. Niveau de conscience', desc:'Éveil global', options:[
        {t:'Normal', v:0}, {t:'Éveillable avec stimulations simples', v:1}, {t:'Éveillable avec stimulations répétées', v:2}, {t:'Coma', v:3}
      ]},
      { id: '2', label: '2. Réponses à 2 questions simples', desc:'Mois / âge', options:[
        {t:'2 réponses correctes', v:0}, {t:'1 réponse correcte', v:1}, {t:'0 réponse correcte', v:2}
      ]},
      { id: '3', label: '3. Réponses à 2 taches simples', desc:'Ouvrir et fermer les yeux / serrer et relacher la main', options:[
        {t:'2 tâches correctes', v:0}, {t:'1 tâche correcte', v:1}, {t:'0 tâche correcte', v:2}
      ]},
       { id: '4', label: '4. Langage', desc:'description objets / phrases - Aphasie', options:[
        {t:'Normale', v:0}, {t:'Légère', v:1}, {t:'Modérée', v:2}, {t:'Sévère / mutique', v:3}
      ]},
      { id: '5', label: '5. Dysarthrie', desc:'Articulation et clareté parole - carte de mots', options:[
        {t:'Normale', v:0}, {t:'Légère', v:1}, {t:'Sévère', v:2}
      ]},
      { id: '6a', label: '6a. Bras gauche', desc:'Maintien 10 s', options:[
        {t:'Maintenu', v:0}, {t:'Descente >10 s', v:1}, {t:'Descente <10 s', v:2}, {t:'Chute immédiate', v:3}, {t:'Aucune élévation', v:4}
      ]},
      { id: '6b', label: '6b. Bras droit', desc:'Maintien 10 s', options:[
        {t:'Maintenu', v:0}, {t:'Descente >10 s', v:1}, {t:'Descente <10 s', v:2}, {t:'Chute immédiate', v:3}, {t:'Aucune élévation', v:4}
      ]},
      { id: '7a', label: '7a. Jambe gauche', desc:'Maintien 5 s', options:[
        {t:'Maintenue', v:0}, {t:'Descente >5 s', v:1}, {t:'Descente <5 s', v:2}, {t:'Chute immédiate', v:3}, {t:'Aucune élévation', v:4}
      ]},
      { id: '7b', label: '7b. Jambe droite', desc:'Maintien 5 s', options:[
        {t:'Maintenue', v:0}, {t:'Descente >5 s', v:1}, {t:'Descente <5 s', v:2}, {t:'Chute immédiate', v:3}, {t:'Aucune élévation', v:4}
       ]}
    ];

  let currentIndex = 0;
  const imgSteps = {};
  const grid = document.getElementById('questions');
  const finalResult = document.getElementById('finalResult');

  function bandFrom(score){
    if(score<=3) return {txt:'minime', cls:'ok'};
    if(score<=10) return {txt:'modéré', cls:'warn'};
    return {txt:'sévère', cls:'bad'};
  }

  function makeRobustImage(srcPath, altText) {
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.className = 'obj-img';
    img.alt = altText || '';

    function setSrc(p) {
      try {
        img.src = new URL(encodeURI(p), location.href).href;
      } catch (e) {
        img.src = p;
      }
    }

    setSrc(srcPath);

    img.onerror = () => {
      console.warn('Échec chargement image, tentative alternative pour :', srcPath);
      if (srcPath.startsWith('./')) {
        const alt = srcPath.slice(2);
        setSrc(alt);
      } else {
        setSrc('./' + srcPath);
      }
      img.onerror = () => {
        console.error('Image introuvable :', srcPath);
        const note = document.createElement('div');
        note.className = 'img-error';
        note.textContent = 'Image introuvable : ' + srcPath;
        img.replaceWith(note);
      };
    };

    return img;
  }

  function renderQuestion(){
    grid.innerHTML = '';
    finalResult.style.display = 'none';
    const q = NIHSS[currentIndex];
    const card = document.createElement('article'); card.className = 'card';
    const h3 = document.createElement('h3'); h3.textContent = q.label;
    const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = q.desc;
    const ctrl = document.createElement('div'); ctrl.className = 'control';

    if (imgSteps[currentIndex] === undefined) imgSteps[currentIndex] = 0;
    const step = imgSteps[currentIndex];

    // --- question 4 : objets -> scène (index 3) ---
    if (currentIndex === 3) {
      const imgWrap = document.createElement('div');
      imgWrap.className = 'img-wrap';
      const images = [
        {src: './objets.png', alt: 'objets à décrire', title: 'Objets'},
        {src: './scene.png', alt: 'scène', title: 'Scène'}
      ];
      const visibleImgIndex = Math.min(step, 1);
      const img = makeRobustImage(images[visibleImgIndex].src, images[visibleImgIndex].alt);
      imgWrap.appendChild(img);

      const actions = document.createElement('div');
      actions.className = 'img-actions';

      const fullscreenBtn = document.createElement('button');
      fullscreenBtn.className = 'btn';
      fullscreenBtn.textContent = 'Plein écran';
      fullscreenBtn.onclick = async () => {
        try {
          if (img.requestFullscreen) await img.requestFullscreen();
          else if (img.webkitRequestFullscreen) img.webkitRequestFullscreen();
          else window.open(img.src, '_blank');
        } catch (err) {
          window.open(img.src, '_blank');
        }
      };

      actions.appendChild(fullscreenBtn);
      imgWrap.appendChild(actions);
      card.append(h3, sub, imgWrap);

      ctrl.className = 'control options-container' + (step < 2 ? ' hidden-options' : '');
    }
    // --- question 5 : mots -> phrases (index 4) ---
    else if (currentIndex === 4) {
      const imgWrap = document.createElement('div'); imgWrap.className = 'img-wrap';
      const images = [
        {src: './mots.png', alt: 'carte de mots', title: 'Mots'},
        {src: './phrases.png', alt: 'phrases à lire', title: 'Phrases'}
      ];
      const visibleImgIndex = Math.min(step, 1);
      const img = makeRobustImage(images[visibleImgIndex].src, images[visibleImgIndex].alt);
      imgWrap.appendChild(img);

      const actions = document.createElement('div'); actions.className = 'img-actions';
      const fullscreenBtn = document.createElement('button'); fullscreenBtn.className = 'btn'; fullscreenBtn.textContent = 'Plein écran';
      fullscreenBtn.onclick = async () => {
        try {
          if (img.requestFullscreen) await img.requestFullscreen();
          else if (img.webkitRequestFullscreen) img.webkitRequestFullscreen();
          else window.open(img.src, '_blank');
        } catch (err) {
          window.open(img.src, '_blank');
        }
      };

      const stepBtn = document.createElement('button'); stepBtn.clas











